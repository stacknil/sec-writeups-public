# Malware Analysis – Egg‑xecutable (TryHackMe / AoC 2025 Day 6)

> Sandbox malware triage of **HopHelper.exe** using **static + dynamic analysis** tools.

---

## 0. Room & Scenario

* **Platform**: TryHackMe – *Malware Analysis: Egg‑xecutable* (Advent of Cyber 2025 – Day 6)
* **Sample**: `HopHelper.exe`

  * Location in lab: `C:\Users\DFIRUser\Desktop\HopHelper\HopHelper.exe`
* **Environment**:

  * Windows VM as **sandbox** (disposable, snapshot‑able).
  * Tools on desktop: **PeStudio**, **Regshot**, **ProcMon** (Process Monitor).
* **Story**:

  * Staff receive a suspicious "scheduling" program via a 3 a.m. email from the chief of elf affairs.
  * Before deployment, we analyse `HopHelper.exe` to confirm if it’s malware and how to defend against it.

---

## 1. Core Concepts

### 1.1 Malware Analysis (恶意软件分析)

* **Goal**: Understand *what the sample does* and *how to detect / contain / eradicate it*.
* Questions we want to answer:

  * Does it communicate with a remote **C2 server**?
  * Does it establish **persistence** (开机自启)?
  * What **artifacts / IOCs** (indicators of compromise) does it leave on disk, in the registry, on the network?
* Two main approaches:

  * **Static analysis 静态分析** – Inspect file *without* executing it (metadata, hash, headers, imports, strings, resources…)
  * **Dynamic analysis 动态分析** – Execute in a controlled environment and observe behaviour (registry, file system, network, processes…).

### 1.2 Sandboxes / 虚拟机沙箱

* **Sandbox**: Isolated environment where we can safely run untrusted code.
* In practice: usually a **virtual machine (VM)** with features like snapshots.
* **Golden rule**: *Never* run suspicious samples on a production / personal host. Always use a sandbox.

### 1.3 Persistence via Registry Run Keys

* Windows can auto‑start programs via **`Run` keys** in the registry.
* Malware commonly abuses:

  * `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
  * `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
* Idea: if the key contains a value pointing to the malware, it will start on every login/boot.

---

## 2. Static Analysis with PeStudio

> Task: triage `HopHelper.exe` *without* running it.

### 2.1 Workflow

1. Launch **PeStudio** from the desktop.
2. Drag‑and‑drop `HopHelper.exe` into the window (or `File → Open`).
3. In the left tree, stay on **file** / **indicators**.
4. In the right pane, locate `file > sha256` – copy the SHA‑256 hash as a key IOC.
5. Navigate to **Strings** view to inspect embedded text.

### 2.2 Observations

* **File metadata** (from PeStudio):

  * PE executable, 64‑bit, GUI subsystem.
  * Linked with Microsoft Linker 14.29; version info shows product name like `HopHelper`.
* **Hash / IOCs**:

  * SHA‑256 recorded from `file > sha256` (unique identifier used for VT search, blocklists, etc.).
* **Strings**:

  * Search for `THM{` near the bottom → embedded CTF **flag** (`THM{...}`).
  * Additional useful strings:

    * File paths on disk (where the EXE may live / drop files).
    * Possible network indicators – IP address / URL used for C2.

### 2.3 Why Strings Matter

* Readable strings often expose:

  * **C2 infrastructure** (domains, IPs, URLs).
  * **Commands or arguments** the malware executes.
  * **Error messages / config keys** revealing features.
* Even if the sample is partly obfuscated, many forget to fully hide paths, registry keys, debug messages.

---

## 3. Dynamic Analysis (1) – Registry Diff with Regshot

> Goal: detect persistence and configuration changes by comparing registry snapshots **before & after** running the sample.

### 3.1 Regshot Workflow

1. Launch **Regshot** from the desktop.
2. Set **Output path** to a convenient folder (e.g. Desktop).
3. Click **1st shot → Shot** to take the baseline snapshot.

   * Wait until completion (status bar shows elapsed time).
4. Execute `HopHelper.exe` **once**:

   * Icons on the desktop change to Easter eggs.
   * A message pops up (King Malhare’s ransom note / prank message).
5. Return to Regshot → **2nd shot → Shot** to capture the post‑infection registry.
6. Click **Compare** to generate a text report of added/removed/changed keys.

### 3.2 Key Findings – Persistence

* In the comparison report, search for `HopHelper`.
* One of the modified keys is a **Run** key:

```text
HKU\S-1-5-21-1966530601-3185510712-10604624-1008\Software\Microsoft\Windows\CurrentVersion\Run\HopHelper
```

* Meaning:

  * Under this user’s hive (`HKU\S-1-5-21-...`), a **Run** entry named `HopHelper` was added.
  * Its data points to `HopHelper.exe` on disk.
  * On next login, Windows will automatically execute HopHelper → **persistence achieved**.

### 3.3 Takeaways from Regshot

* Regshot is ideal for:

  * Quickly spotting **persistence mechanisms** (Run keys, services, shell extensions, etc.).
  * Discovering **configuration changes** (e.g., disabling Defender, modifying firewall or policy keys).
* For a full investigation, we would:

  * Extract all registry changes touching `Run`, `Services`, browser settings, and security products.
  * Turn them into **detection rules** (e.g. SIEM alerts on new Run keys pointing to unusual paths).

---

## 4. Dynamic Analysis (2) – Behaviour with Process Monitor (ProcMon)

> Goal: observe how `HopHelper.exe` interacts with **file system, registry, and network** in real time.

### 4.1 ProcMon Workflow

1. Launch **Process Monitor** from the desktop.
2. Ensure capturing is **ON** ("Capture"/Play button pressed).
3. Execute `HopHelper.exe` again so its behaviour is recorded.
4. After the ransom UI finishes, stop capturing (press the Play button again).
5. Apply filters to reduce noise:

   * `Filter → Filter…`
   * Condition: `Process Name  is  HopHelper.exe` (or `contains hophelper`) → **Add → OK**.
6. Optional: further filter by **Operation**:

   * E.g. `Operation  contains  TCP` to focus on network events only.

### 4.2 Observed Behaviour

* With filters applied we see operations like:

  * `RegOpenKey`, `RegSetValue` (registry writes – consistent with persistence key from Regshot).
  * `CreateFile`, `ReadFile`, `WriteFile` (file system activity; possibly logs or config files).
  * `TCP Connect`, `TCP Send`, `TCP Receive`, `TCP Disconnect`.
* Detail pane for the TCP events shows:

  * Destination IP / port.
  * **Protocol** used at application layer (HTTP over TCP).

### 4.3 Interpretation

* HopHelper is not just a local prank; it **phones home**:

  * Establishes **TCP** connections and sends/receives data using **HTTP**.
  * Likely talking to a web‑based command panel (bonus challenge in the room).
* Combined with strings & Regshot findings we can now:

  * Extract **network IOCs** (destination IP, URL path) for blocking at firewall / proxy.
  * Confirm **registry Run key** as persistence.
  * Document **behaviour profile** (file, registry, network) for detection rules.

---

## 5. Consolidated IOCs & Artefacts

> What we would put into an incident report / threat intel entry.

* **File**

  * Name: `HopHelper.exe`
  * Location: user Desktop `HopHelper` folder.
  * Type: 64‑bit Windows GUI executable (PE).
  * Hash: SHA‑256 from PeStudio (`file > sha256`).

* **Registry (Persistence)**

  * `HKU\\S-1-5-21-1966530601-3185510712-10604624-1008\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\HopHelper`

* **Network**

  * Outbound **TCP** connections.
  * Application protocol: **HTTP**.
  * C2 endpoint: IP / URL visible in strings & ProcMon event details (record exact values when doing the lab).

* **User‑visible symptoms**

  * Desktop icons turn into **Easter eggs**.
  * Ransom / prank message “King Malhare sends his regards”.

---

## 6. Workflow Cheat Sheet 

### 6.1 Static Analysis Quick Steps

1. Open sample in **PeStudio**.
2. Record **hashes** (SHA‑256) + basic metadata.
3. Scan **Strings** for:

   * `THM{` / `FLAG{` etc.
   * IPs, domains, URLs.
   * Registry paths, file paths.
4. Optionally inspect **Imports**, **Resources**, **Sections** for suspicious patterns (packed code, strange APIs, embedded PE files, etc.).

### 6.2 Dynamic Analysis – Registry (Regshot)

1. Regshot → set output path.
2. **1st Shot** (baseline snapshot).
3. Run sample once.
4. **2nd Shot** (post‑execution snapshot).
5. **Compare** → search sample name → identify persistence keys.

### 6.3 Dynamic Analysis – Behaviour (ProcMon)

1. Start ProcMon capture.
2. Run sample; wait for activity to finish.
3. Stop capture.
4. Filter by `Process Name` = sample.
5. Optionally filter by `Operation`:

   * `contains TCP` → network.
   * `contains RegSetValue` → registry writes.
   * `contains CreateFile` → file creation.
6. Inspect details for each event → extract paths, keys, IPs, URLs.

---

## 7. Key Takeaways 

* **Static + dynamic analysis** complement each other:

  * Static tells you what the binary *might* do.
  * Dynamic shows what it *actually* does in a controlled run.
* **Sandboxes / VMs** are mandatory whenever handling untrusted samples.
* Simple free tools (PeStudio, Regshot, ProcMon) already provide a strong
  **triage pipeline**:

  1. Hash & strings (PeStudio) → basic fingerprint + early IOCs.
  2. Registry diff (Regshot) → persistence & configuration tampering.
  3. Behaviour trace (ProcMon) → file/registry/network behaviour & C2.
* Practice pattern: whenever you get a suspicious EXE:

  1. Drop into sandbox VM.
  2. Run PeStudio first.
  3. If still suspicious, move to Regshot + ProcMon dynamic analysis.
  4. Export IOCs into SIEM / firewall / endpoint rules.

> This note is for my own blue‑team malware triage playbook; concrete hashes/IPs/URLs should be filled in from the current lab run when I repeat the room.
